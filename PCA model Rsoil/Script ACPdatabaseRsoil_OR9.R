
#######################################################################################

'data.frame':   2496 obs. of  14 variables:
 $ Time      : num  17.5 18 18.5 19 19.5 20 20.5 21 21.5 22 ...
 $ Rsoil     : num  3.45 3.51 3.41 3.37 3.48 ...
 $ Ta        : num  21.6 20.8 20.4 20.5 20.8 ...
 $ Rh        : num  86.3 89 92.7 91.1 89.3 ...
 $ Ws        : num  0.383 0.853 0.973 0.569 0.408 ...
 $ Rain      : num  0 0 0 0 0 0.3 0 0.5 0.4 0 ...
 $ ETo       : num  0.0355 0.047 0.0458 0.0312 0.0256 ...
 $ Ca26m     : num  NA NA 384 385 NA ...
 $ CO2_amb   : num  401 417 420 417 421 ...
 $ Reco      : num  10.44 9.83 9.52 9.63 9.81 ...
 $ GPP       : num  8.05 9.03 9.08 7.74 7.18 ...
 $ SWC15cm   : num  58.2 58.2 58.1 58.2 58.1 ...
 $ Tsoil_surf: num  21.2 21.1 21 20.9 20.9 ...
 $ Tsoil_10cm: num  21.3 21.3 21.3 21.3 21.4 ...

#######################################################################################

 'data.frame':   2496 obs. of  13 variables:
 $ Time      : num  17.5 18 18.5 19 19.5 20 20.5 21 21.5 22 ...
 $ Rsoil     : num  3.45 3.51 3.41 3.37 3.48 ...
 $ Ta        : num  21.6 20.8 20.4 20.5 20.8 ...
 $ Rh        : num  86.3 89 92.7 91.1 89.3 ...
 $ Ws        : num  0.383 0.853 0.973 0.569 0.408 ...
 $ Rain      : num  0 0 0 0 0 0.3 0 0.5 0.4 0 ...
 $ ETo       : num  0.0355 0.047 0.0458 0.0312 0.0256 ...
 $ Ca26m     : num  NA NA 384 385 NA ...
 $ CO2_amb   : num  401 417 420 417 421 ...
 $ GPP       : num  8.05 9.03 9.08 7.74 7.18 ...
 $ SWC15cm   : num  58.2 58.2 58.1 58.2 58.1 ...
 $ Tsoil_surf: num  21.2 21.1 21 20.9 20.9 ...
 $ Tsoil_10cm: num  21.3 21.3 21.3 21.3 21.4 ...
 
#######################################################################################
 $Dim.1
$Dim.1$quanti
           correlation       p.value
ETo         0.83565154  0.000000e+00
Ta          0.83130243  0.000000e+00
Tsoil_surf  0.68640787  0.000000e+00
GPP         0.65371747  0.000000e+00
Ws          0.64909674  0.000000e+00
Rain       -0.06836047  6.318157e-04
Tsoil_10cm -0.16777402  3.237485e-17
SWC15cm    -0.16839193  2.471091e-17
Ca26m      -0.53517180 5.320923e-185
Rh         -0.56603506 1.877678e-211
CO2_amb    -0.72405562  0.000000e+00

#######################################################################################
$Dim.2
$Dim.2$quanti
           correlation       p.value
SWC15cm     0.64633952  0.000000e+00
Rain        0.49421198  0.000000e+00
ETo         0.12453653  4.291363e-10
Ws          0.09623819  1.458543e-06
GPP         0.08588610  1.733912e-05
Ca26m       0.06658191  8.732798e-04
Ta         -0.06708063  7.981203e-04
Rh         -0.33796415  9.744106e-68
Tsoil_surf -0.42395405 1.883041e-109
Tsoil_10cm -0.65049755 2.742584e-300

#######################################################################################
$Dim.3
$Dim.3$quanti
           correlation      p.value
Rain        0.61178233 0.000000e+00
Tsoil_10cm  0.48324907 0.000000e+00
Tsoil_surf  0.42620521 0.000000e+00
SWC15cm     0.42529656 0.000000e+00
Rh          0.11045046 3.161080e-08
GPP         0.06461897 1.237376e-03
Ta         -0.09003651 6.633500e-06
ETo        -0.18321116 2.787233e-20
Ws         -0.20849682 6.474800e-26
Ca26m      -0.21320134 4.756700e-27
CO2_amb    -0.23675539 3.853634e-33

#######################################################################################
$Dim.4
$Dim.4$quanti
           correlation       p.value
Ca26m       0.59491530  0.000000e+00
Rain        0.31817345  0.000000e+00
Tsoil_10cm  0.26162924  0.000000e+00
Ws          0.23598208  0.000000e+00
Ta          0.18734400  0.000000e+00
Tsoil_surf  0.07313762  2.551621e-04
ETo         0.07103914  3.825699e-04
SWC15cm    -0.17573423  9.219295e-19
Rh         -0.41546063 9.341244e-105
GPP        -0.48364465 1.635820e-146

#######################################################################################
$Dim.5
$Dim.5$quanti
           correlation      p.value
CO2_amb     0.58294571 0.000000e+00
Tsoil_10cm  0.38368883 0.000000e+00
GPP         0.27874228 0.000000e+00
Rain        0.17431175 0.000000e+00
ETo         0.16066526 6.661338e-16
Ta          0.12459628 4.209282e-10
SWC15cm    -0.08644419 1.527505e-05
Ca26m      -0.22989940 2.697182e-31
Rh         -0.24705174 5.035978e-36
Tsoil_surf -0.27883941 8.346567e-46

#######################################################################################
$Dim.6
$Dim.6$quanti
           correlation       p.value
SWC15cm     0.52937758  0.000000e+00
Ca26m       0.27106922  0.000000e+00
Tsoil_10cm  0.24647135  0.000000e+00
ETo         0.17135649  0.000000e+00
GPP         0.07643834  1.320847e-04
Tsoil_surf  0.06770687  7.122378e-04
CO2_amb     0.04845266  1.548198e-02
Ta          0.04195155  3.610249e-02
Ws         -0.09444570  2.281862e-06
Rh         -0.11678654  4.863844e-09
Rain       -0.45833796 6.793261e-130

#######################################################################################
$Dim.7
$Dim.7$quanti
           correlation      p.value
Ws          0.62574145 0.000000e+00
Rh          0.43199199 0.000000e+00
SWC15cm     0.16012231 8.881784e-16
CO2_amb     0.11347235 1.311149e-08
Tsoil_10cm  0.11082475 2.838185e-08
ETo         0.05908861 3.145311e-03
Rain        0.04423368 2.711289e-02
Tsoil_surf -0.05468817 6.278002e-03

#######################################################################################
$Dim.8
$Dim.8$quanti
        correlation      p.value
GPP       0.4281573 0.000000e+00
Ca26m     0.4173996 0.000000e+00
Rh        0.1947099 0.000000e+00
ETo       0.1930555 0.000000e+00
Rain      0.1617196 4.440892e-16
Ta       -0.1073727 7.565232e-08
Ws       -0.1247947 3.947505e-10
SWC15cm  -0.1579267 2.089557e-15

#######################################################################################
$Dim.9
$Dim.9$quanti
           correlation      p.value
Ta          0.40246447 0.000000e+00
Rh          0.28435958 0.000000e+00
ETo         0.21058422 0.000000e+00
Rain        0.08214778 3.973902e-05
CO2_amb     0.08203111 4.075867e-05
SWC15cm     0.05473992 6.228809e-03
Tsoil_10cm -0.07564988 1.549522e-04
GPP        -0.19148532 4.856051e-22
Ws         -0.22909457 4.401422e-31

#######################################################################################
$Dim.10
$Dim.10$quanti
           correlation      p.value
Ta          0.26430477 0.000000e+00
GPP         0.15266293 1.731948e-14
Ca26m       0.08545370 1.911818e-05
CO2_amb    -0.03937260 4.920262e-02
Tsoil_surf -0.07617055 1.394692e-04
ETo        -0.32033059 1.155878e-60

#######################################################################################
Call:
lm(formula = All$Rsoil ~ dim.ind)

Residuals:
     Min       1Q   Median       3Q      Max 
-2.76035 -0.26775  0.00755  0.30386  1.83898 

Coefficients:
               Estimate Std. Error t value Pr(>|t|)    
(Intercept)    2.984292   0.013665 218.396  < 2e-16 ***
dim.indDim.1   0.027386   0.006645   4.121 4.00e-05 ***
dim.indDim.2  -0.316290   0.009654 -32.762  < 2e-16 ***
dim.indDim.3  -0.239096   0.011315 -21.131  < 2e-16 ***
dim.indDim.4   0.026517   0.012522   2.118  0.03439 *  
dim.indDim.5   0.044539   0.015266   2.918  0.00358 ** 
dim.indDim.6  -0.348071   0.014881 -23.390  < 2e-16 ***
dim.indDim.7  -0.135091   0.015182  -8.898  < 2e-16 ***
dim.indDim.8   0.074376   0.017394   4.276 2.03e-05 ***
dim.indDim.9  -0.060546   0.020648  -2.932  0.00342 ** 
dim.indDim.10 -0.019753   0.028985  -0.681  0.49569    
---
Signif. codes:  0 ?***? 0.001 ?**? 0.01 ?*? 0.05 ?.? 0.1 ? ? 1

Residual standard error: 0.5015 on 1371 degrees of freedom
  (1114 observations deleted due to missingness)
Multiple R-squared:  0.6048,    Adjusted R-squared:  0.602 
F-statistic: 209.9 on 10 and 1371 DF,  p-value: < 2.2e-16
#######################################################################################






# Importer le fichier :
All <- read.delim("C:/Users/JuniorPastor/Master Junior, Karel, Olivier (11-11-2013)/Datos/Articulo 1_Rsoil/Rsoil Chamber Robot/Datos/PCA model Rsoil/Rsoilpredictors_non-Reco.csv", header=T, sep=",")
attach(All)
str(All)

#$$$$$$$$$$$$$$$$$$ PCA $$$$$$$$$$$$$$$$$$$$$$
#Le premier objectif sera de choisir les covariables ici pour qu'elles ne soient pas colineaires

library(FactoMineR)# http://factominer.free.fr/classical-methods/analyse-en-composantes-principales.html
#res.pca=PCA(All,scale.unit=TRUE, ncp=10, graph=T)
res.pca=PCA(All[,-c(1,2)],scale.unit=TRUE, ncp=10, graph=T)#
#res.pca=PCA(All[,-c(1,2,5:12,16:17)],scale.unit=TRUE, ncp=15, graph=T)# -c pour exclure colonnes
#res.pca=PCA(All[,-c(1,8,9,10,7,8,9)],scale.unit=TRUE, ncp=5, quanti.sup=c(1), graph=T)# pour exclure les colonnes 1, pour rajouter la colonne 2 (yield) en variable illustrative
#scale.unit: pour choisir de r?duire ou non les variables 
#ncp: le nombre de dimensions ? garder dans les r?sultats
#quanti.sup: vecteur des index des variables continues illustratives, ici Yield
#graph: pour choisir de faire appara?tre les graphiques ou non

#names(res.pca)#noms de ce qu'on peut r?cup?rer dans res.pca : [1] "eig");"var"        "ind"        "svd"        "quanti.sup" "call"  
res.pca$eig #% variance cumulee par axe : an eigenvalue is a measure of the heterogeneity associated with a principal component, which is a linear combination of different variables. Other multivariate measures of variation are
#res.pca$var #% variance de chaque variable sur un axe donn? (total = 100 par axe)
#res.pca$ind #% variance de chaque individu sur un axe donn? (total = 100 par axe)
#res.pca$quali.sup #
#res.pca$quanti.sup #
#res.pca$ind.sup# pour individus supprimes

dimdesc(res.pca, axes=c(1,2,3,4,5,6,7,8,9,10))#seules les variables actives et illustratives dont la probabilit? critique est inf?rieure ? 0.05 apparaissent.

dim.var=res.pca$var$coord
dim.var # coordonn?es de variables sur les axes (matrice)

dim.ind=res.pca$ind$coord
dim.ind # coordonn?es de individus sur les axes (matrice)

#dim.ind.3axes<-dim.ind[,-c(4,5)]#Pour ne travailler que sur 3 colonnes
#dim.ind.3axes

m.ind=lm(All$Rsoil~dim.ind)#correlation en var a predire et projections des ind 
summary(m.ind)

a<-data.frame(dim.ind)
a
str(a)
Dim.1<-a[1]
Dim.2<-a[2]
Dim.3<-a[3]
Dim.4<-a[4]
Dim.5<-a[5]
Dim.6<-a[6]
Dim.7<-a[7]
Dim.8<-a[8]
Dim.9<-a[9]
Dim.10<-a[10]


RsoilMOD<- 0.027386*Dim.1-0.316290 *Dim.2-0.239096*Dim.3+0.026517*Dim.4 +0.044539*Dim.5 -0.348071*Dim.6 -0.135091*Dim.7 + 0.074376 *Dim.8 -0.060546 *Dim.9 -0.019753 *Dim.10 + 2.984292#10 axes
RsoilMOD
QQtable<-data.frame(Rsoil, RsoilMOD)#pour cr?er un table ? partir des deux vecteurs
QQtable


data1<-data.frame(Rsoil,RsoilMOD)
data1

#Export output data to file: 
write.table(data1,"C:/Users/JuniorPastor/Master Junior, Karel, Olivier (11-11-2013)/Datos/Articulo 1_Rsoil/Rsoil Chamber Robot/Datos/PCA model Rsoil/OutRsoilpredictors_non-Reco.csv",  sep=",")

#$$$$$$$$$$$$$$$$$$$$$$$ PLOT $$$$$$$$$$$$$$
#Ne fonctionne qu'en l'absence de donn?es manquantes
plot(Rsoil,RsoilMOD[,1], main="",sub="", xlab="", ylab="",pch=19,col="black", bg="black", xlim=c(-0.5, 5.5), ylim=c(-0.5, 5.5))  #pch=19 pour des points noirs
# Add fit lines
#Rajout une droite
abline(a = 0, b = 1, col = "black", lty = "dotted", lwd = 3)# trace une droite d'ordonn?e ? l'origine 1 et de pente 2.
text(5, 5, "[1,1]", pos = 1, col = "black", cex = 1, srt = 0)
abline(lm(RsoilMOD[,1]~Rsoil), col="black") # regression line (y~x)
#Title and axes
title(main="R2=0.60; p<0.001; RRMSE=",sub="", xlab="Rts (?molCO2m-2s-1)", ylab="Rts (?molCO2m-2s-1)")
#Legend : http://www.duclert.org/Aide-memoire-R/Graphiques/Rajout-d-elements.php?words=graphe
#legend("topright", legend = c("A", "B"), col = c("red", "blue"), pch = 15, bty = "n", pt.cex = 2, cex = 0.8, text.col = "forestgreen", horiz = TRUE, inset = c(0.1, 0.1)) 
#Rajout de texte





#$$$$$$$$$$$$$$$$$$$$$$$ SCATTERPLOT MATRIX  $$$$$$$$$$$$$$

# Scatterplot Matrices from the gclus Package 
library(ade4)
library(gclus)
#dta <- All 
dta <- All[c(2,3,4,5,6,7,8,9,10)] # get data from columns of file
dta.r <- abs(cor(dta)) # get correlations
dta.col <- dmat.color(dta.r) # get colors
# reorder variables so those with highest correlation are closest to the diagonal
dta.o <- order.single(dta.r) 
cpairs(dta, dta.o, panel.colors=dta.col, gap=.5,main="Variables Ordered and Colored by Correlation" ) 

#Basic Scatterplot Matrix
pairs(~Yield+Nfert+Pruning+LAIJ_A_N+LAIA_S_N+LAI6_month_N, 
   main="Title")

# Scatterplot Matrices with regression
library(car)
scatterplot.matrix(~Yield+Nfert+Pruning+LAIJ_A_N+LAIA_S_N+LAI6_month_N, 
   main="Title")



#$$$$$$$$$$$$$$$$$$$$$$$$$$$Tableaux ANOVA des principales regressions interessantes$$$$$$$$$$

library(stats)

#Variable1 = Y; Variable 2 = X
fit0<-lm(Yield~LAI6MONTHyrN)
summary(fit0)
fit1<-lm(Yield~Nfert)
summary(fit1)
fit2<-lm(Yield~Pruning)
summary(fit2)
fit2bis<-lm(Yield~LAIJAN_APRyrN)
summary(fit2bis)
fit2ter<-lm(Yield~LAIAUG_SEPyrN)
summary(fit2ter)
fit2quat<-lm(Yield~LAIJ_J_N_1)
summary(fit2quat)



fit3<-lm(Yield~LAI6_month_N)
summary(fit3)
fit4<-lm(Yield~LAI8MONTHyrNN_1)
summary(fit4)

#Variable1 = Y; (Variable 2,Variable3,Variable4) = X
fit5<-lm(Yield~Nfert+LAI6MONTHyrN)
summary(fit5)
fit6<-lm(Yield~Nfert+LAIJAN_APRyrN+LAIAUG_SEPyrN)
summary(fit6)
fit6bis<-lm(Yield~Nfert+LAIJAN_APRyrN+LAIAUG_SEPyrN+Pruning)
summary(fit6bis)

covar.a.tester<- ShootHeight, Year (1), age (2),  (3), basal_diam (4), Bwood (5), 
#Bleaves (6), Bbrother (7), log_NCI (8), max_nb_fruit (9), T_ShTree (10), aPAR(MJ_Y-1) (11), 
#Rate_PnShade (12), Pn(gC_Y-1) (13), Lleaves (14), Lfruit (15), NPPwood (16), NPPleaves (17), 
#NPPfruit (18), k_wood (19), k_leaf (20), k_fruit (21), k_Lleaf (22), k_Lfruit (23), 
#RNPP_wood (24), RNPP_leaf (25), RNPP_fruit (26), LUE_wood (27), LUE_leaf (28), LUE_fruit (29)
# ecrire ici le modele pr?f?re ? tester

fit7<-lm(Yield~covar.a.tester)
summary(fit7)

#Predicted values in a vector
Yieldmod<-fitted(fit7)

#$$$$$$$$$$$$$$$$$$$$$$$ PLOT $$$$$$$$$$$$$$
#Ne fonctionne qu'en l'absence de donn?es manquantes
plot(Yieldmod, Yield, main="R2=0.8; p=0.03",xlab="Yield_meas(kg_green coffee ha-1 yr-1)", ylab="Yield_mod(kg_green coffee ha-1 yr-1)", 
pch=19) #pch=19 pour des points noirs
# Add fit lines
abline(lm(Yield~Yieldmod), col="black") # regression line (y~x)

#$$$$$$$$$$$$$$$$$$$$$$$$$$ STEPWISE and regression subset selection $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

# Stepwise Regression: sur la stepwise lorsque que c'est une stepwise deux sens ( rajout et  d?l?tion  de variable), la stepwise est capable d'enlever des variables trop colin?aire et de finalement trouver la meilleur combinaison.( ici ona trop peu de point pour que ?a marche 
library(MASS)
step <- stepAIC(fit7, direction="both")#forward, backward or both
step$anova # display results 

# All Subsets Regression
#Aide : http://cran.r-project.org/web/packages/leaps/index.html
library(car)
library(leaps)# Choisir le miroir de CRAN "0-cloud" puis "installer le package" "leaps"
leaps<-regsubsets(Yield~Nfert+LAI8_month+Pruning,data=All,nbest=10)
# view results 
summary(leaps)
# plot a table of models showing variables in each model.
# models are ordered by the selection statistic.
plot(leaps,scale="r2")#Other options for plot( ) are bic, Cp, and adjr2
# plot statistic by subset size 
subsets(leaps, statistic="bic") #Other options for plotting with subset( ) are bic, cp, adjr2, and rss. 

#$$$$$$$$$$$$$$$$$$$$$$$$$$ MODEL DIAGNOSTICS $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

library(car)

# Global test of linear model assumptions
library(gvlma)
gvmodel <- gvlma(fit7) 
summary(gvmodel) 


# Test for Autocorrelated Errors
durbinWatsonTest(fit7)#H0 = p=0, residus independant; H1= p>0 residus  corr?l?s


# Assessing Outliers
outlierTest(fit7) # Bonferonni p-value for most extreme obs
qqPlot(fit7, main="QQ Plot") #qq plot for studentized resid 
leveragePlots(fit7) # leverage plots 

# Influential Observations
# added variable plots 
#av.Plots(fit7) ne fonctionne pas
# Cook's D plot
# identify D values > 4/(n-k-1) 
cutoff <- 4/((nrow(mtcars)-length(fit7$coefficients)-2)) 
plot(fit7, which=4, cook.levels=cutoff)
# Influence Plot 
influencePlot(fit7, id.method="identify", main="Influence Plot", sub="Circle size is proportial to Cook's Distance" )

# Normality of Residuals
# qq plot for studentized resid
qqPlot(fit7, main="QQ Plot")
# distribution of studentized residuals

library(MASS)
sresid <- studres(fit7) 
hist(sresid, freq=FALSE, main="Distribution of Studentized Residuals")
xfit<-seq(min(sresid),max(sresid),length=40) 
yfit<-dnorm(xfit) 
lines(xfit, yfit) 

# Evaluate homoscedasticity
# non-constant error variance test
ncvTest(fit7)
# plot studentized residuals vs. fitted values 
spreadLevelPlot(fit7)

# Evaluate Collinearity
vif(fit7) # variance inflation factors 
sqrt(vif(fit7)) > 2 

# Evaluate Nonlinearity
# component + residual plot 
crPlots(fit7)
# Ceres plots 
ceresPlots(fit7)



